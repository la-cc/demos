apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: vcluster-project-x
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  destination:
    namespace: vcluster-project-x
    server: "https://kubernetes.default.svc"
  sources:
    - repoURL: https://github.com/la-cc/demos.git
      targetRevision: main
      path: "./guest-lecture-platform-engineering-org-2025-how-to-build-a-multitenancy-internal-developer-platform/managed-service-catalog/helm/vcluster"
      helm:
        ignoreMissingValueFiles: true
        releaseName: "vcluster-project-x"
        valueFiles:
          - "values.yaml"
        values: |
          externalSecret:
            enabled: true
          namespaceName: vcluster-project-x
          rbac:
            groupName: "la-demos:g-gitops"
          vcluster:
            controlPlane:
              coredns:
                deployment:
                  tolerations:
                    - key: "project"
                      operator: "Equal"
                      value: "project-x"
                      effect: "NoSchedule"
                  nodeSelector:
                    project: "project-x"
              proxy:
                extraSANs:
                  - vcluster-project-x.pe-org-lecture.stackit.run
              ingress:
                enabled: true
                host: "vcluster-project-x.pe-org-lecture.stackit.run"
                pathType: ImplementationSpecific
                annotations:
                  nginx.ingress.kubernetes.io/backend-protocol: HTTPS
                  nginx.ingress.kubernetes.io/ssl-passthrough: "true"
                  nginx.ingress.kubernetes.io/ssl-redirect: "true"
                  cert-manager.io/cluster-issuer: letsencrypt-prod
                spec:
                  ingressClassName: nginx
              statefulSet:
                scheduling:
                  tolerations:
                    - key: "project"
                      operator: "Equal"
                      value: "project-x"
                      effect: "NoSchedule"
                  nodeSelector:
                    project: "project-x"
              backingStore:
                etcd:
                  deploy:
                    statefulSet:
                      scheduling:
                        tolerations:
                          - key: "project"
                            operator: "Equal"
                            value: "project-x"
                            effect: "NoSchedule"
                        nodeSelector:
                          project: "project-x"
  project: default
  syncPolicy:
    automated:
      selfHeal: true
      prune: true
      allowEmpty: true
    syncOptions:
      - CreateNamespace=false
      - PruneLast=true
      - FailOnSharedResource=true
      - RespectIgnoreDifferences=true
      - ApplyOutOfSyncOnly=true
      - ServerSideApply=true